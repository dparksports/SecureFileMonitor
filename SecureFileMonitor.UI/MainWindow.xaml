<Window x:Class="SecureFileMonitor.UI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SecureFileMonitor.UI"
        xmlns:vm="clr-namespace:SecureFileMonitor.UI.ViewModels"
        xmlns:conv="clr-namespace:SecureFileMonitor.UI.Converters"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        mc:Ignorable="d"
        Title="Secure File Monitor - PROTECTED" Height="650" Width="1000"
        Background="#181818"
        WindowStartupLocation="CenterScreen">
    <Window.Resources>
        <conv:ViewToVisibilityConverter x:Key="ViewToVisibilityConverter"/>
        <conv:ViewToColorConverter x:Key="ViewToColorConverter"/>
        <conv:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <conv:FileSizeConverter x:Key="FileSizeConverter"/>
        <conv:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <conv:BooleanToStatusConverter x:Key="BooleanToStatusConverter"/>
        <conv:BooleanToStatusColorConverter x:Key="BooleanToStatusColorConverter"/>
        <conv:BindingProxy x:Key="Proxy" Data="{Binding}"/>
        
        <Style TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="#333"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0,0,1,1"/>
            <Setter Property="BorderBrush" Value="#444"/>
        </Style>



        <Style TargetType="DatePicker">
            <Setter Property="Background" Value="#333"/>
            <Setter Property="Foreground" Value="Black"/>
        </Style>

        <Style TargetType="DataGridRow">
            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
        </Style>

        <!-- Dark Button Style to fix white text issues -->
        <Style x:Key="DarkButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#333"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" BorderThickness="{TemplateBinding BorderThickness}" BorderBrush="{TemplateBinding BorderBrush}" CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#555"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#000"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Background" Value="#222"/>
                                <Setter Property="Foreground" Value="Gray"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <HierarchicalDataTemplate x:Key="FolderTreeTemplate" ItemsSource="{Binding Children}">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="📁" Margin="0,0,5,0" Foreground="Goldenrod"/>
                <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                <TextBlock Text="{Binding FileCount, StringFormat=' ({0})'}" Foreground="Gray" FontSize="10" VerticalAlignment="Center" Margin="5,0,0,0"/>
            </StackPanel>
        </HierarchicalDataTemplate>

        <CollectionViewSource x:Key="GroupedFilesSource" Source="{Binding FilteredFiles}">
            <CollectionViewSource.GroupDescriptions>
                <PropertyGroupDescription PropertyName="DirectoryName"/> <!-- Assumes FileEntry has DirectoryName or we use FilePath and converter? FileEntry has FilePath. We need a property or Converter. -->
            </CollectionViewSource.GroupDescriptions>
        </CollectionViewSource>

        <!-- Timeline Template -->
        <DataTemplate x:Key="TimelineItemTemplate">
            <Border Width="12" VerticalAlignment="Bottom" Margin="1,0" ToolTip="{Binding Tooltip}">
                <Border.Height>
                    <Binding Path="Intensity">
                        <Binding.Converter>
                             <conv:ViewToVisibilityConverter/>
                        </Binding.Converter>
                    </Binding>
                </Border.Height>
                <Border.Background>
                    <SolidColorBrush Color="SpringGreen" Opacity="{Binding Intensity}"/>
                </Border.Background>
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Height" Value="{Binding FileCount}"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                <Setter Property="BorderBrush" Value="White"/>
                                <Setter Property="BorderThickness" Value="1"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
            </Border>
        </DataTemplate>

        <!-- Modern UI Resources -->
        <Style x:Key="HeroButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#1E1E1E"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Height" Value="180"/>
            <Setter Property="Margin" Value="10"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="15" BorderThickness="1" BorderBrush="#333">
                            <Border.Effect>
                                <DropShadowEffect Color="Black" BlurRadius="20" ShadowDepth="5" Opacity="0.5"/>
                            </Border.Effect>
                            <Grid>
                                <Border x:Name="glow" Background="Transparent" CornerRadius="15" BorderThickness="2" BorderBrush="{StaticResource CyberpunkGreenBrush}" Opacity="0"/>
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#252525"/>
                                <Setter TargetName="glow" Property="Opacity" Value="1"/>
                                <Setter TargetName="glow" Property="BorderBrush" Value="#00FF7F"/>
                                <Setter TargetName="glow" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="#00FF7F" BlurRadius="15" ShadowDepth="0" Opacity="0.6"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ModernToggleStyle" TargetType="CheckBox">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Border Background="#252525" CornerRadius="8" Padding="15" Margin="0,0,0,10" BorderBrush="#333" BorderThickness="1">
                             <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CheckStates">
                                    <VisualState x:Name="Checked">
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="KnobTranslate" Storyboard.TargetProperty="X" To="24" Duration="0:0:0.2"/>
                                            <ColorAnimation Storyboard.TargetName="Track" Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)" To="#00FF7F" Duration="0:0:0.2"/>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="Unchecked">
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="KnobTranslate" Storyboard.TargetProperty="X" To="0" Duration="0:0:0.2"/>
                                            <ColorAnimation Storyboard.TargetName="Track" Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)" To="#444" Duration="0:0:0.2"/>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            <DockPanel LastChildFill="False">
                                <StackPanel DockPanel.Dock="Left" VerticalAlignment="Center">
                                    <ContentPresenter Content="{TemplateBinding Content}" TextElement.FontWeight="Bold"/>
                                    <TextBlock Text="{TemplateBinding Tag}" Foreground="Gray" FontSize="11" Margin="0,2,0,0" TextWrapping="Wrap" MaxWidth="300"/>
                                </StackPanel>
                                <Border DockPanel.Dock="Right" x:Name="Track" Width="50" Height="26" CornerRadius="13" Background="#444">
                                    <Ellipse Width="22" Height="22" Fill="White" HorizontalAlignment="Left" Margin="2,0,0,0">
                                        <Ellipse.RenderTransform>
                                            <TranslateTransform x:Name="KnobTranslate" X="0"/>
                                        </Ellipse.RenderTransform>
                                    </Ellipse>
                                </Border>
                            </DockPanel>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <DataTemplate x:Key="DriveCardTemplate">
            <Border Background="#1E1E1E" CornerRadius="8" Padding="15" Margin="0,0,0,10" BorderBrush="#333" BorderThickness="1">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <CheckBox IsChecked="{Binding IsSelected}" VerticalAlignment="Center" Margin="0,0,15,0">
                        <CheckBox.LayoutTransform>
                            <ScaleTransform ScaleX="1.5" ScaleY="1.5"/>
                        </CheckBox.LayoutTransform>
                    </CheckBox>
                    
                    <Grid Grid.Column="1">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <DockPanel Grid.Row="0" LastChildFill="False" Margin="0,0,0,8">
                            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                                <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="White" FontSize="16"/>
                                <TextBlock Text="{Binding Label, StringFormat=' ({0})'}" Foreground="#AAA" FontSize="16" Margin="5,0,0,0"/>
                            </StackPanel>
                            <TextBlock DockPanel.Dock="Right" Foreground="#AAA" FontSize="12" VerticalAlignment="Bottom">
                                <Run Text="{Binding UsagePercentage, StringFormat={}{0:0}%, Mode=OneWay}" Foreground="{StaticResource CyberpunkGreenBrush}" FontWeight="Bold"/>
                                <Run Text=" used"/>
                            </TextBlock>
                        </DockPanel>
                        
                        <ProgressBar Grid.Row="1" Height="6" Value="{Binding UsagePercentage, Mode=OneWay}" Maximum="100" 
                                     Background="#333" Foreground="{StaticResource CyberpunkGreenBrush}" BorderThickness="0" Margin="0,0,0,8"/>
                        
                        <DockPanel Grid.Row="2" LastChildFill="False">
                            <TextBlock DockPanel.Dock="Left" Text="Healthy" Foreground="{StaticResource CyberpunkGreenBrush}" FontSize="11">
                                <Run Text=" • Ready" Foreground="#666"/>
                            </TextBlock>
                            <TextBlock DockPanel.Dock="Right" Foreground="#666" FontSize="11">
                                <Run Text="{Binding TotalSize, Mode=OneWay}"/>
                                <Run Text=" total"/>
                            </TextBlock>
                        </DockPanel>
                    </Grid>
                </Grid>
            </Border>
        </DataTemplate>

        <Style x:Key="SidebarButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="3,0,0,0"/>
            <Setter Property="Height" Value="75"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <Grid>
                                    <!-- Active Indicator Glow (Optional) -->
                                <Border Background="{TemplateBinding BorderBrush}" Opacity="0.1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#11FFFFFF"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.3"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>



        <!-- Main Content -->
        <Grid Grid.Row="0"> 
                <Grid.RowDefinitions>
                    <RowDefinition Height="60"/> <!-- Header -->
                    <RowDefinition Height="*"/>  <!-- Main Content Row -->
                </Grid.RowDefinitions>

                <!-- Header -->
                <Grid Grid.Row="0" Background="#181818" Margin="20,0,20,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Branding (Top Left) -->
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <Border Width="32" Height="32" Margin="0,0,10,0">
                            <Border.Effect>
                                <DropShadowEffect Color="#00FF7F" BlurRadius="10" ShadowDepth="0" Opacity="0.8"/>
                            </Border.Effect>
                            <!-- Shield Icon: Changed from E771 to E83D (Defender Shield) -->
                            <TextBlock Text="&#xE83D;" FontFamily="Segoe MDL2 Assets" FontSize="24" Foreground="{StaticResource CyberpunkGreenBrush}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <TextBlock Text="Secure File Monitor" FontSize="18" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Utility Icons (Top Right) -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                        <Button Style="{DynamicResource SidebarButtonStyle}" Width="40" Height="40" Margin="0,0,10,0" ToolTip="Notifications">
                             <!-- Bell Icon: Changed from E7E7 (Bubble) to EA8F (Ringer) -->
                             <TextBlock Text="&#xEA8F;" FontFamily="Segoe MDL2 Assets" FontSize="18" Foreground="#AAA"/>
                        </Button>
                        <Button Command="{Binding SwitchViewCommand}" CommandParameter="SETTINGS"
                                Style="{DynamicResource SidebarButtonStyle}" Width="40" Height="40" Margin="0,0,10,0" ToolTip="Settings"
                                BorderBrush="{Binding CurrentViewName, Converter={StaticResource ViewToColorConverter}, ConverterParameter=SETTINGS}"
                                Foreground="{Binding CurrentViewName, Converter={StaticResource ViewToForegroundConverter}, ConverterParameter=SETTINGS}">
                             <TextBlock Text="&#xE713;" FontFamily="Segoe MDL2 Assets" FontSize="18"/>
                        </Button>
                        <Border Width="36" Height="36" CornerRadius="18" BorderThickness="2" BorderBrush="{StaticResource CyberpunkGreenBrush}" Margin="10,0,0,0">
                             <TextBlock Text="&#xE77B;" FontFamily="Segoe MDL2 Assets" FontSize="18" Foreground="#888" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </StackPanel>
                </Grid>

                <!-- Main Content Area (Sidebar + Feature View) -->
                <Grid Grid.Row="1" Margin="20,0,20,15">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="90"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Sidebar -->
                    <Grid Grid.Column="0" Margin="0,0,10,0" Background="{StaticResource NavyBackgroundBrush}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>



                <!-- Branding removed from sidebar (moved to header) -->

                <!-- Navigation -->
                <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Hidden">
                    <StackPanel>
                        <!-- Scan -->
                        <Button Command="{Binding SwitchViewCommand}" CommandParameter="SCAN"
                                Style="{DynamicResource SidebarButtonStyle}"
                                BorderBrush="{Binding CurrentViewName, Converter={StaticResource ViewToColorConverter}, ConverterParameter=SCAN}"
                                Foreground="{Binding CurrentViewName, Converter={StaticResource ViewToForegroundConverter}, ConverterParameter=SCAN}">
                            <StackPanel>
                                <TextBlock Text="&#xE768;" FontFamily="Segoe MDL2 Assets" FontSize="20" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                                <TextBlock Text="SCAN" FontSize="9" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <!-- Dashboard / Vault -->
                        <Button Command="{Binding SwitchViewCommand}" CommandParameter="VAULT"
                                Style="{StaticResource SidebarButtonStyle}"
                                BorderBrush="{Binding CurrentViewName, Converter={StaticResource ViewToColorConverter}, ConverterParameter=VAULT}"
                                Foreground="{Binding CurrentViewName, Converter={StaticResource ViewToForegroundConverter}, ConverterParameter=VAULT}">
                            <StackPanel>
                                <TextBlock Text="&#xE80F;" FontFamily="Segoe MDL2 Assets" FontSize="20" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                                <TextBlock Text="VAULT" FontSize="9" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <!-- Security / Live -->
                        <Button Command="{Binding SwitchViewCommand}" CommandParameter="LIVE"
                                Style="{StaticResource SidebarButtonStyle}"
                                BorderBrush="{Binding CurrentViewName, Converter={StaticResource ViewToColorConverter}, ConverterParameter=LIVE}"
                                Foreground="{Binding CurrentViewName, Converter={StaticResource ViewToForegroundConverter}, ConverterParameter=LIVE}">
                            <StackPanel>
                                <TextBlock Text="&#xE72E;" FontFamily="Segoe MDL2 Assets" FontSize="20" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                                <TextBlock Text="MONITOR LIVE" FontSize="9" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <!-- Diagnostics / File Changes -->
                        <Button Command="{Binding SwitchViewCommand}" CommandParameter="FILES_CHANGES"
                                Style="{StaticResource SidebarButtonStyle}"
                                BorderBrush="{Binding CurrentViewName, Converter={StaticResource ViewToColorConverter}, ConverterParameter=FILES_CHANGES}"
                                Foreground="{Binding CurrentViewName, Converter={StaticResource ViewToForegroundConverter}, ConverterParameter=FILES_CHANGES}">
                            <StackPanel>
                                <TextBlock Text="&#xE9D2;" FontFamily="Segoe MDL2 Assets" FontSize="20" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                                <TextBlock Text="CHANGES" FontSize="9" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <!-- Duplicates -->
                        <Button Command="{Binding SwitchViewCommand}" CommandParameter="DUPLICATES"
                                IsEnabled="{Binding IsDuplicateScanAvailable}" 
                                ToolTip="Run a Full Scan to enable duplicate detection"
                                ToolTipService.ShowOnDisabled="True"
                                Style="{StaticResource SidebarButtonStyle}"
                                BorderBrush="{Binding CurrentViewName, Converter={StaticResource ViewToColorConverter}, ConverterParameter=DUPLICATES}"
                                Foreground="{Binding CurrentViewName, Converter={StaticResource ViewToForegroundConverter}, ConverterParameter=DUPLICATES}">
                            <StackPanel>
                                <TextBlock Text="&#xE11D;" FontFamily="Segoe MDL2 Assets" FontSize="20" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                                <TextBlock Text="DUPLICATES" FontSize="9" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </ScrollViewer>

                <!-- Footer Navigation -->
                <StackPanel Grid.Row="1" Margin="0,10,0,20">
                    <Border Height="1" Background="#333" Margin="10,0,10,15"/>
                    
                     <!-- Inspect / Ignore -->
                    <Button Command="{Binding SwitchViewCommand}" CommandParameter="IGNORE_LIST"
                            Style="{StaticResource SidebarButtonStyle}"
                            Height="65"
                            BorderBrush="{Binding CurrentViewName, Converter={StaticResource ViewToColorConverter}, ConverterParameter=IGNORE_LIST}"
                            Foreground="{Binding CurrentViewName, Converter={StaticResource ViewToForegroundConverter}, ConverterParameter=IGNORE_LIST}">
                        <StackPanel>
                            <TextBlock Text="&#xE7B3;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                            <TextBlock Text="IGNORE LIST" FontSize="9" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <!-- Settings -->
                    <Button Command="{Binding SwitchViewCommand}" CommandParameter="SETTINGS"
                            Style="{StaticResource SidebarButtonStyle}"
                            Height="65"
                            BorderBrush="{Binding CurrentViewName, Converter={StaticResource ViewToColorConverter}, ConverterParameter=SETTINGS}"
                            Foreground="{Binding CurrentViewName, Converter={StaticResource ViewToForegroundConverter}, ConverterParameter=SETTINGS}">
                        <StackPanel>
                            <TextBlock Text="&#xE713;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                            <TextBlock Text="SETTINGS" FontSize="9" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- Main Content Area -->
            <Border Grid.Column="1" Background="#11FFFFFF" CornerRadius="8" Padding="10">
                <Grid>
                    <Grid Visibility="{Binding CurrentViewName, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=SCAN}">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel Margin="30">
                                <!-- Breadcrumb -->
                                <TextBlock Text="Dashboard > Scan" Foreground="Gray" Margin="0,0,0,20"/>
                                
                                <!-- Hero Section -->
                                <Grid Margin="0,0,0,40">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Scan New Button -->
                                    <Button Grid.Column="0" Command="{Binding ScanNewFilesCommand}" Style="{StaticResource HeroButtonStyle}"
                                            IsEnabled="{Binding IsScanning, Converter={StaticResource InverseBooleanConverter}}">
                                        <StackPanel HorizontalAlignment="Center">
                                            <TextBlock Text="📂" FontSize="40" HorizontalAlignment="Center" Margin="0,0,0,15" Foreground="{StaticResource CyberpunkGreenBrush}"/>
                                            <TextBlock Text="Quick Scan" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                                            <TextBlock Text="Fast scan on critical paths and new files." FontSize="12" Foreground="#AAA" HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <!-- Full Scan Button -->
                                    <Button Grid.Column="1" Command="{Binding FullScanCommand}" Style="{StaticResource HeroButtonStyle}"
                                            IsEnabled="{Binding IsScanning, Converter={StaticResource InverseBooleanConverter}}">
                                        <StackPanel HorizontalAlignment="Center">
                                            <TextBlock Text="🔍" FontSize="40" HorizontalAlignment="Center" Margin="0,0,0,15" Foreground="{StaticResource CyberpunkGreenBrush}"/>
                                            <TextBlock Text="Full Scan" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                                            <TextBlock Text="Comprehensive scan of all drives." FontSize="12" Foreground="#AAA" HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </Grid>
                                
                                <!-- Active Scan Controls (Visible only when scanning) -->
                                <Border Visibility="{Binding IsScanning, Converter={StaticResource BooleanToVisibilityConverter}}" 
                                        Background="#1E1E1E" CornerRadius="10" Padding="20" Margin="0,0,0,40"
                                        BorderBrush="{StaticResource CyberpunkGreenBrush}" BorderThickness="1">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel>
                                            <TextBlock Text="SCAN IN PROGRESS..." Foreground="{StaticResource CyberpunkGreenBrush}" FontWeight="Bold" FontSize="18" Margin="0,0,0,5"/>
                                            <TextBlock Text="{Binding StatusMessage}" Foreground="#DDD"/>
                                            <TextBlock Text="{Binding ScanETA}" Foreground="Gray" Margin="0,5,0,0"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                                             <Button Command="{Binding PauseScanCommand}" Content="⏸ PAUSE" Width="100" Height="40"
                                                     Background="Orange" Foreground="Black" FontWeight="Bold" Margin="0,0,10,0" Style="{StaticResource DarkButtonStyle}"
                                                     Visibility="{Binding IsPaused, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=INVERSE}"/>
                                             <Button Command="{Binding ResumeScanCommand}" Content="▶ RESUME" Width="100" Height="40"
                                                     Background="{StaticResource CyberpunkGreenBrush}" Foreground="Black" FontWeight="Bold" Margin="0,0,10,0" Style="{StaticResource DarkButtonStyle}"
                                                     Visibility="{Binding IsPaused, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                             <Button Command="{Binding StopScanCommand}" Content="⏹ STOP" Width="100" Height="40"
                                                     Background="#FF4444" Foreground="White" FontWeight="Bold" Style="{StaticResource DarkButtonStyle}"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>

                                <!-- Main Columns -->
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="5*"/>
                                        <ColumnDefinition Width="30"/> <!-- Spacer -->
                                        <ColumnDefinition Width="4*"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Left: Target Drives -->
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Target Drives" FontSize="18" FontWeight="SemiBold" Foreground="White" Margin="0,0,0,15"/>
                                        
                                        <!-- Actions -->
                                        <Button Command="{Binding LoadDrivesCommand}" Content="🔄 Refresh List" 
                                                HorizontalAlignment="Right" Margin="0,-35,0,0"
                                                Background="Transparent" BorderThickness="0" Foreground="#888"/>
                                                
                                        <ItemsControl ItemsSource="{Binding AvailableDrives}" ItemTemplate="{StaticResource DriveCardTemplate}"/>
                                    </StackPanel>

                                    <!-- Right: Scan Options -->
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="Scan Options" FontSize="18" FontWeight="SemiBold" Foreground="White" Margin="0,0,0,15"/>
                                        
                                        <CheckBox Style="{StaticResource ModernToggleStyle}" IsChecked="{Binding UseThreads}" Content="Multi-threading" 
                                                  Tag="Enable faster scanning using multiple CPU cores."/>
                                                  
                                        <CheckBox Style="{StaticResource ModernToggleStyle}" IsChecked="{Binding SkipWindows}" Content="Skip System Files" 
                                                  Tag="Exclude Windows directory to speed up scanning."/>
                                                  
                                        <CheckBox Style="{StaticResource ModernToggleStyle}" IsChecked="{Binding SkipProgramFiles}" Content="Skip Program Files" 
                                                  Tag="Exclude installed applications folders."/>
                                                  
                                        <CheckBox Style="{StaticResource ModernToggleStyle}" IsChecked="{Binding SkipRecycleBin}" Content="Skip Recycle Bin" 
                                                  Tag="Ignore deleted files in the Recycle Bin."/>
                                        
                                         <CheckBox Style="{StaticResource ModernToggleStyle}" IsChecked="{Binding VerifyGpuHash}" Content="GPU Hash Verification" 
                                                  Tag="Use advanced GPU acceleration to verify file integrity (Experimental)."
                                                  Visibility="{Binding UseGpu, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>

                    <!-- VAULT View -->
                    <Grid Visibility="{Binding CurrentViewName, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=VAULT}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Filter & Action Controls -->
                        <Grid Margin="0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <Button Command="{Binding LoadAllFilesCommand}" Content="📋 Refresh List" 
                                            Background="#333" Foreground="White" Padding="10,5" Margin="0,0,10,0"/>
                                    
                                    <ToggleButton IsChecked="{Binding IsFileDetailsVisible}" Content="ℹ️ Details" 
                                                  Background="{Binding IsFileDetailsVisible, Converter={StaticResource ViewToColorConverter}, ConverterParameter=TRUE}" 
                                                  Foreground="White" Padding="10,5" Margin="0,0,0,0"/>

                                    <CheckBox IsChecked="{Binding EnableIgnoreList}" Content="Filter Ignored" VerticalAlignment="Center" Foreground="White" FontWeight="SemiBold" Margin="10,0,0,0"/>
                                </StackPanel>
                            </StackPanel>

                            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Top" Margin="0,10,0,10">
                                <TextBlock Text="SORT BY:" Foreground="White" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,5,0" FontSize="11"/>
                                <ComboBox ItemsSource="{Binding SortByOptions}" SelectedItem="{Binding SortBy}" 
                                          Width="120" Margin="0,0,10,0" Height="25"/>
                                
                                <TextBlock Text="Type:" FontWeight="Bold" VerticalAlignment="Center" Margin="10,0,5,0" Foreground="White" FontSize="11"/>
                                <ComboBox ItemsSource="{Binding FileTypeOptions}" SelectedItem="{Binding FileTypeFilter}" 
                                          Width="100" Padding="5,2" Height="25"/>
                                
                                <TextBlock Text="Date Range:" FontWeight="Bold" VerticalAlignment="Center" Margin="10,0,5,0" Foreground="White" FontSize="11"/>
                                <DatePicker SelectedDate="{Binding DateFilterStart}" Width="110" Background="#333" Foreground="Black" BorderThickness="1" BorderBrush="#555" Margin="0,0,5,0" Height="25"/>
                                <TextBlock Text="to" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="White"/>
                                <DatePicker SelectedDate="{Binding DateFilterEnd}" Width="110" Foreground="Black" Margin="0,0,10,0" Height="25"/>
                            </StackPanel>
                        </Grid>
                        
                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>


                            <!-- Hierarchical Navigation View -->
                            <Grid Grid.Column="0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="250" MinWidth="150" MaxWidth="400"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Left: Directory Tree -->
                                <Border Background="#1A1A1A" BorderBrush="#333" BorderThickness="0,0,1,0">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="FOLDERS" Foreground="Gray" FontWeight="Bold" Margin="10,5"/>
                                        <TreeView Grid.Row="1" ItemsSource="{Binding RootFolders}" ItemTemplate="{StaticResource FolderTreeTemplate}"
                                                  Background="Transparent" BorderThickness="0" Foreground="White">
                                            <TreeView.ItemContainerStyle>
                                                <Style TargetType="TreeViewItem">
                                                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                                    <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                                                    <Setter Property="BindingGroup" Value="{Binding CurrentFolder, Mode=TwoWay}"/> <!-- Hacky binding? No -->
                                                    <!-- Simple selection binding in VM via IsSelected property on nodes -->
                                                </Style>
                                            </TreeView.ItemContainerStyle>
                                            <i:Interaction.Triggers>
                                                <i:EventTrigger EventName="SelectedItemChanged">
                                                    <i:InvokeCommandAction Command="{Binding DataContext.FilterCommand, RelativeSource={RelativeSource AncestorType=Window}}" /> 
                                                    <!-- Actually, we bind SelectedItem. VM uses IsSelected property on nodes or we bind SelectedItem here.
                                                         WPF TreeView SelectedItem is read-only. We need a behavior or just rely on IsSelected property in FolderNode.
                                                         ViewModel listens to PropertyChanged of FolderNodes? Or we bind a behavior.
                                                         Simplest: Event to Command with EventArgs, pass NewValue. -->
                                                    <!-- Let's just use the VM property 'CurrentFolder' set via the IsSelected binding style if possible, 
                                                         BUT TreeViewItem.IsSelected doesn't automatically sync to a single 'CurrentFolder' property in VM easily without exclusive selection logic.
                                                         Let's assume the user clicks, and we just use 'SelectedItemChanged' event to set 'CurrentFolder' in CodeBehind or use an Interaction Trigger passing the Item. -->
                                                    <i:InvokeCommandAction Command="{Binding Data.SetCurrentFolderCommand, Source={StaticResource Proxy}}" 
                                                                           CommandParameter="{Binding SelectedItem, RelativeSource={RelativeSource AncestorType=TreeView}}"/> 
                                                    <!-- Wait, I don't have SetCurrentFolderCommand. I use 'CurrentFolder' property.
                                                         I need to be able to set it.
                                                         Let's add a behavior or simple code-behind if needed? 
                                                         Or simpler: Just use the IsSelected two-way binding on the ContainerStyle, 
                                                         and in FolderNode setter of IsSelected, if true, update the VM Main CurrentFolder?
                                                         Yes, that requires FolderNode to have reference to VM or Messenger.
                                                         
                                                         Alternative: Interaction.Triggers standard way:
                                                         CommandParameter is the SelectedItem.
                                                         I need a command in VM "SetCurrentFolder". I don't have it.
                                                         I'll add a relay command for this or use 'UpdateSelectionTally' style?
                                                         
                                                         Let's hack: Bind to 'CurrentFolder' using a Behavior? Too complex to add 5 files.
                                                         Let's just use the `Source={StaticResource Proxy}` to call a command `SelectFolder` which I will add to VM implicitly or just rely on the user clicking and us handling it.
                                                         
                                                         Actually, I'll add `[RelayCommand] public void SelectFolder(FolderNode folder) => CurrentFolder = folder;` to VM if I can.
                                                         But I can't edit VM again easily right now.
                                                         
                                                         EXISTING properties? `CurrentFolder` is a property.
                                                         Can I bind TreeView.SelectedItem to it? not in pure XAML easily.
                                                         
                                                         Let's try to stick to what I have. I have `FolderNode.IsSelected`. 
                                                         If I bind `IsSelected` in ItemContainerStyle, when I click, it sets True.
                                                         VM needs to know.
                                                         
                                                         I'll add the `SetCurrentFolderCommand` to the VM in a quick edit afterwards if needed, 
                                                         OR I can just rely on the `ApplyFilters` being called when `CurrentFolder` changes.
                                                         To change `CurrentFolder`, I need the binding.
                                                    
                                                         I will stick with: `IsSelected` binding. 
                                                         AND I will add a `SelectFolder` command to VM quickly before I forget.
                                                         Actually, `FolderNode` is simple.
                                                         
                                                         Let's use `i:InvokeCommandAction` with a new command I'll add: `SelectFolder`.
                                                    -->
                                                </i:EventTrigger>
                                            </i:Interaction.Triggers>
                                        </TreeView>
                                    </Grid>
                                </Border>

                                <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Center" Background="#333"/>

                                <!-- Right: Content -->
                                <Grid Grid.Column="2">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/> <!-- Timeline -->
                                        <RowDefinition Height="Auto"/> <!-- Chips -->
                                        <RowDefinition Height="*"/>    <!-- DataGrid -->
                                        <RowDefinition Height="Auto"/> <!-- Splitter -->
                                        <RowDefinition Height="200"/>  <!-- History -->
                                    </Grid.RowDefinitions>
                                    
                                    <!-- Timeline -->
                                    <Border Background="#222" Margin="0,0,0,5" Padding="5">
                                        <StackPanel>
                                            <TextBlock Text="ACTIVITY TIMELINE" Foreground="Gray" FontSize="9" FontWeight="Bold" Margin="0,0,0,2"/>
                                            <!-- ItemsControl for bars -->
                                            <ItemsControl ItemsSource="{Binding ActivityStats}" ItemTemplate="{StaticResource TimelineItemTemplate}" Height="50" VerticalAlignment="Bottom">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Bottom"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                            </ItemsControl>
                                            <!-- Simple Interaction: Click on timeline? logic needed. For now just visual. -->
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Filter Chips -->
                                    <Border Grid.Row="1" Background="#222" Margin="0,0,0,5" Padding="5">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="FILTERS:" Foreground="Gray" FontSize="9" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                            <ItemsControl ItemsSource="{Binding ExtensionChips}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <ToggleButton Content="{Binding Description}" IsChecked="{Binding IsChecked}" 
                                                                      Background="Transparent" Foreground="White" BorderThickness="1" BorderBrush="#444" 
                                                                      Margin="0,0,5,0" Padding="5,2" FontSize="10">
                                                            <ToggleButton.Style>
                                                                <Style TargetType="ToggleButton">
                                                                    <Style.Triggers>
                                                                        <Trigger Property="IsChecked" Value="True">
                                                                            <Setter Property="Background" Value="#333"/>
                                                                            <Setter Property="BorderBrush" Value="SpringGreen"/>
                                                                            <Setter Property="Foreground" Value="SpringGreen"/>
                                                                        </Trigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </ToggleButton.Style>
                                                        </ToggleButton>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>

                                    <!-- Grouped DataGrid -->
                                    <!-- Note: Using GroupedFilesSource resource -->
                                    <DataGrid Grid.Row="2" x:Name="VaultDataGrid" ItemsSource="{Binding Source={StaticResource GroupedFilesSource}}" AutoGenerateColumns="False" 
                                              Background="Transparent" BorderThickness="0" HeadersVisibility="Column"
                                              IsReadOnly="True" RowBackground="#222" AlternatingRowBackground="#2A2A2A" Foreground="White"
                                              SelectedItem="{Binding SelectedFile}" SelectionMode="Extended">
                                        
                                        <DataGrid.GroupStyle>
                                             <GroupStyle>
                                                 <GroupStyle.HeaderTemplate>
                                                     <DataTemplate>
                                                         <StackPanel>
                                                             <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="#87CEFA" Padding="5" Background="#333"/>
                                                         </StackPanel>
                                                     </DataTemplate>
                                                 </GroupStyle.HeaderTemplate>
                                                 <GroupStyle.ContainerStyle>
                                                     <Style TargetType="{x:Type GroupItem}">
                                                         <Setter Property="Template">
                                                             <Setter.Value>
                                                                 <ControlTemplate TargetType="{x:Type GroupItem}">
                                                                     <Expander IsExpanded="True" BorderThickness="0,0,0,1" BorderBrush="#444">
                                                                         <Expander.Header>
                                                                             <StackPanel Orientation="Horizontal">
                                                                                 <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="SpringGreen" VerticalAlignment="Bottom"/>
                                                                                 <TextBlock Text="{Binding ItemCount, StringFormat=' ({} items)'}" Foreground="Gray" FontStyle="Italic" VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                                                                             </StackPanel>
                                                                         </Expander.Header>
                                                                         <ItemsPresenter />
                                                                     </Expander>
                                                                 </ControlTemplate>
                                                             </Setter.Value>
                                                         </Setter>
                                                     </Style>
                                                 </GroupStyle.ContainerStyle>
                                             </GroupStyle>
                                        </DataGrid.GroupStyle>

                                        <i:Interaction.Triggers>
                                            <i:EventTrigger EventName="SelectionChanged">
                                                <i:InvokeCommandAction Command="{Binding UpdateSelectionTallyCommand}" 
                                                                       CommandParameter="{Binding SelectedItems, ElementName=VaultDataGrid}"/>
                                            </i:EventTrigger>
                                        </i:Interaction.Triggers>
                                        <DataGrid.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="🏷️ Tag Selected Files" 
                                                          Command="{Binding Data.TagSelectedFilesCommand, Source={StaticResource Proxy}}"
                                                          CommandParameter="{Binding Path=PlacementTarget.SelectedItems, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                <MenuItem Header="🎙️ Transcribe Selected" 
                                                          Command="{Binding Data.TranscribeSelectedFilesCommand, Source={StaticResource Proxy}}"
                                                          CommandParameter="{Binding Path=PlacementTarget.SelectedItems, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                <Separator/>
                                                <MenuItem Header="🚫 Ignore these files" 
                                                          Command="{Binding Data.IgnoreSelectedFilesCommand, Source={StaticResource Proxy}}"
                                                          CommandParameter="{Binding Path=PlacementTarget.SelectedItems, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                <MenuItem Header="✅ Unignore these files" 
                                                          Command="{Binding Data.UnignoreSelectedFilesCommand, Source={StaticResource Proxy}}"
                                                          CommandParameter="{Binding Path=PlacementTarget.SelectedItems, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                <Separator/>
                                                <MenuItem Header="📂 Open in Explorer" 
                                                          Command="{Binding Data.OpenInExplorerCommand, Source={StaticResource Proxy}}"
                                                          CommandParameter="{Binding Path=PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                <MenuItem Header="💻 Open in VS Code" 
                                                          Command="{Binding Data.OpenInVsCodeCommand, Source={StaticResource Proxy}}"
                                                          CommandParameter="{Binding Path=PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                <MenuItem Header="🐚 Open in PowerShell" 
                                                          Command="{Binding Data.OpenInPowerShellCommand, Source={StaticResource Proxy}}"
                                                          CommandParameter="{Binding Path=PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                <MenuItem Header="📟 Open in CMD" 
                                                          Command="{Binding Data.OpenInCmdCommand, Source={StaticResource Proxy}}"
                                                          CommandParameter="{Binding Path=PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                            </ContextMenu>
                                        </DataGrid.ContextMenu>
                                        <DataGrid.Columns>
                                            <DataGridCheckBoxColumn Header="Ignored" Binding="{Binding IsIgnored}" Width="60"/>
                                            <DataGridTextColumn Header="Name" Binding="{Binding FileName}" Width="200">
                                                <DataGridTextColumn.ElementStyle>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="FontWeight" Value="Bold"/>
                                                    </Style>
                                                </DataGridTextColumn.ElementStyle>
                                            </DataGridTextColumn>
                                            <DataGridTextColumn Header="Path" Binding="{Binding FilePath}" Width="*"/>
                                            <DataGridTextColumn Header="Type" Binding="{Binding FileType}" Width="120"/>
                                            <DataGridTextColumn Header="Size" Binding="{Binding FileSize, Converter={StaticResource FileSizeConverter}}" Width="100"/>
                                            <DataGridTextColumn Header="Created" Binding="{Binding CreationTime, StringFormat=yyyy-MM-dd HH:mm}" Width="140"/>
                                            <DataGridTextColumn Header="Modified" Binding="{Binding LastModified, StringFormat=yyyy-MM-dd HH:mm}" Width="140"/>
                                        </DataGrid.Columns>
                                    </DataGrid>

                                    <!-- Splitter -->
                                    <GridSplitter Grid.Row="3" Height="5" HorizontalAlignment="Stretch" Background="#333" ShowsPreview="True"/>

                                    <!-- History Panel -->
                                    <Border Grid.Row="4" Background="#1A1A1A" BorderBrush="#333" BorderThickness="0,1,0,0">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            <Border Background="#222" Padding="10,5">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="FILE HISTORY" FontWeight="Bold" Foreground="Gray" VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding SelectedFile.FileName, StringFormat=' - {0}'}" Foreground="SpringGreen" FontWeight="Bold" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                                </StackPanel>
                                            </Border>
                                            
                                            <DataGrid Grid.Row="1" ItemsSource="{Binding SelectedFileHistory}" AutoGenerateColumns="False" 
                                                      Background="Transparent" BorderThickness="0" HeadersVisibility="Column"
                                                      IsReadOnly="True" RowBackground="#1A1A1A" AlternatingRowBackground="#222" Foreground="White"
                                                      GridLinesVisibility="Horizontal" HorizontalGridLinesBrush="#333">
                                                <DataGrid.Columns>
                                                    <DataGridTextColumn Header="Time" Binding="{Binding Timestamp, StringFormat=yyyy-MM-dd HH:mm:ss}" Width="150">
                                                        <DataGridTextColumn.ElementStyle>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Foreground" Value="#AAA"/>
                                                            </Style>
                                                        </DataGridTextColumn.ElementStyle>
                                                    </DataGridTextColumn>
                                                    <DataGridTextColumn Header="Operation" Binding="{Binding Operation}" Width="100">
                                                         <DataGridTextColumn.ElementStyle>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Foreground" Value="SpringGreen"/>
                                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                            </Style>
                                                        </DataGridTextColumn.ElementStyle>
                                                    </DataGridTextColumn>
                                                    <DataGridTextColumn Header="Process" Binding="{Binding ProcessName}" Width="150" Foreground="White"/>
                                                    <DataGridTextColumn Header="User" Binding="{Binding UserName}" Width="100" Foreground="Gray"/>
                                                    <DataGridTextColumn Header="Path" Binding="{Binding FilePath}" Width="*" Foreground="Gray"/>
                                                </DataGrid.Columns>
                                            </DataGrid>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </Grid>

                            <!-- Side Panels (Stacked Horizontally) -->
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                
                                <!-- Transcription Side Panel -->
                                <Border Width="350" Background="#1A1A1A" BorderBrush="#333" BorderThickness="1,0,0,0" Margin="10,0,0,0"
                                        Visibility="{Binding IsTranscribeViewVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <Grid Margin="10">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="TRANSCRIPTION HISTORIAL" FontWeight="Bold" Foreground="Gray" Margin="0,0,0,10"/>
                                        
                                        <StackPanel Grid.Row="1" Margin="0,0,0,10">
                                            <TextBox Text="{Binding TranscribedFileSearchQuery, UpdateSourceTrigger=PropertyChanged}" 
                                                     Background="#333" Foreground="White" Padding="5" Tag="Search Transcripts..."/>
                                            <DatePicker SelectedDate="{Binding TranscribedDateFilter}" Margin="0,5,0,0" Background="#333"/>
                                        </StackPanel>

                                        <ListBox Grid.Row="2" ItemsSource="{Binding FilteredTranscribedFiles}" Background="Transparent" BorderThickness="0">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="#252525" Margin="0,0,0,5" Padding="8" CornerRadius="4">
                                                        <StackPanel>
                                                            <TextBlock Text="{Binding FileName}" FontWeight="Bold" Foreground="SpringGreen"/>
                                                            <TextBlock Text="{Binding Transcript}" Foreground="White" MaxHeight="60" TextWrapping="Wrap" FontSize="11" Margin="0,3"/>
                                                            <TextBlock Text="{Binding CompletedAt, StringFormat=yyyy-MM-dd HH:mm}" Foreground="Gray" FontSize="9" HorizontalAlignment="Right"/>
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </Grid>
                                </Border>

                                <!-- File Details Panel -->
                                <Border Width="300" Background="#1A1A1A" BorderBrush="#333" BorderThickness="1,0,0,0" Margin="10,0,0,0"
                                        Visibility="{Binding IsFileDetailsVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <StackPanel Margin="15">
                                            <TextBlock Text="FILE DETAILS" FontWeight="Bold" Foreground="Gray" Margin="0,0,0,10"/>
                                            
                                            <!-- Preview Section -->
                                            <Border Height="150" Background="#000" CornerRadius="4" Margin="0,0,0,15" ClipToBounds="True">
                                                <Grid>
                                                    <!-- Image Preview -->
                                                    <Image Source="{Binding SelectedFile.FilePath}" Stretch="Uniform" 
                                                           Visibility="{Binding SelectedFile.FileType, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=Image}"/>
                                                    
                                                    <!-- Video Preview (Thumbnail/Player) -->
                                                    <MediaElement Source="{Binding SelectedFile.FilePath}" LoadedBehavior="Pause" ScrubbingEnabled="True" Stretch="Uniform"
                                                                  Visibility="{Binding SelectedFile.FileType, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=Video}"/>
                                                    
                                                    <!-- Fallback for others -->
                                                    <TextBlock Text="No Preview" Foreground="#555" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Grid>
                                            </Border>

                                            <TextBlock Text="Name" Foreground="Gray" FontSize="10"/>
                                            <TextBox Text="{Binding SelectedFile.FileName, Mode=OneWay}" Background="Transparent" BorderThickness="0" Foreground="White" IsReadOnly="True" TextWrapping="Wrap" FontWeight="Bold" Margin="0,0,0,10"/>

                                            <TextBlock Text="Path" Foreground="Gray" FontSize="10"/>
                                            <TextBox Text="{Binding SelectedFile.FilePath, Mode=OneWay}" Background="Transparent" BorderThickness="0" Foreground="LightGray" IsReadOnly="True" TextWrapping="Wrap" Margin="0,0,0,10"/>

                                            <Grid Margin="0,0,0,10">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel>
                                                    <TextBlock Text="Created" Foreground="Gray" FontSize="10"/>
                                                    <TextBlock Text="{Binding SelectedFile.CreationTime, StringFormat=yyyy-MM-dd HH:mm}" Foreground="White"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="Modified" Foreground="Gray" FontSize="10"/>
                                                    <TextBlock Text="{Binding SelectedFile.LastModified, StringFormat=yyyy-MM-dd HH:mm}" Foreground="White"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                                    <TextBlock Text="Accessed" Foreground="Gray" FontSize="10"/>
                                                    <TextBlock Text="{Binding SelectedFile.LastAccessTime, StringFormat=yyyy-MM-dd HH:mm}" Foreground="White"/>
                                                </StackPanel>
                                            </Grid>

                                            <TextBlock Text="User Tags" Foreground="Gray" FontSize="10" Margin="0,5,0,0"/>
                                            <TextBox Text="{Binding SelectedFileTags, UpdateSourceTrigger=PropertyChanged}" Background="#333" Foreground="White" Padding="5" Margin="0,2,0,10"/>
                                            <Button Command="{Binding SaveTagsCommand}" Content="Save Tags" Background="#333" Foreground="SpringGreen" Padding="10,5" HorizontalAlignment="Right" Margin="0,0,0,15"/>

                                            <TextBlock Text="Transcript / Caption" Foreground="Gray" FontSize="10"/>
                                            <TextBox Text="{Binding SelectedFileTranscript, Mode=OneWay}" Background="#222" Foreground="White" BorderThickness="0" 
                                                     IsReadOnly="True" TextWrapping="Wrap" MinHeight="60" MaxHeight="200" VerticalScrollBarVisibility="Auto" Padding="5"/>
                                        </StackPanel>
                                    </ScrollViewer>
                                </Border>
                            </StackPanel>

                        </Grid>
                    </Grid>

                    <!-- LIVE ACTIVITY View -->
                    <Grid Visibility="{Binding CurrentViewName, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=LIVE}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <Grid Grid.Row="0" Margin="0,0,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Monitoring Controls (Moved here) -->
                            <Border Background="#222" CornerRadius="4" Padding="10" Margin="0,0,10,0">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="MONITORING:" FontWeight="Bold" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,10,0" FontSize="10"/>
                                    <Button Command="{Binding StartMonitoringCommand}" Content="Start" Background="Green" Foreground="White" Padding="10,2" Margin="0,0,5,0" FontSize="12" IsEnabled="{Binding IsMonitoring, Converter={StaticResource InverseBooleanConverter}}"/>
                                    <Button Command="{Binding StopMonitoringCommand}" Content="Stop" Background="Red" Foreground="White" Padding="10,2" Margin="0,0,15,0" FontSize="12" IsEnabled="{Binding IsMonitoring}"/>
                                    
                                    <CheckBox IsChecked="{Binding MonitorInternalDatabase}" Content="Monitor Internal DB" Foreground="Gray" FontSize="11" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <CheckBox IsChecked="{Binding ScanReparseFolders}" Content="Scan Reparse Folders" Foreground="Gray" FontSize="11" VerticalAlignment="Center"/>
                                    
                                    <Separator Width="1" Background="#444" Margin="15,0"/>
                                    <TextBlock Text="Status:" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,5,0" FontSize="11"/>
                                    <TextBlock Text="{Binding IsMonitoring, Converter={StaticResource BooleanToStatusConverter}}" 
                                             Foreground="{Binding IsMonitoring, Converter={StaticResource BooleanToStatusColorConverter}}" 
                                             FontWeight="Bold" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            
                            <Button Grid.Column="1" Command="{Binding ToggleIgnoredProcessesPanelCommand}" 
                                    Content="🚫 Ignored Processes" Background="#333" Foreground="White" Padding="10,5"/>
                        </Grid>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
                             <TextBlock Text="REAL-TIME EVENTS" FontWeight="SemiBold" Foreground="LightGray" VerticalAlignment="Center" Margin="0,0,10,0"/>
                             <ToggleButton IsChecked="{Binding IsLiveActivityPaused}" Content="⏸️ Pause Updates" Background="#333" Foreground="White" Padding="10,2" Margin="0,0,10,0"/>
                             
                             <CheckBox IsChecked="{Binding ShowDllEvents}" Content="Show DLLs" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,10,0"/>
                             <CheckBox IsChecked="{Binding ShowExeEvents}" Content="Show EXEs" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,10,0"/>
                             <CheckBox IsChecked="{Binding ShowMuiEvents}" Content="Show MUIs" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,10,0"/>
                             <CheckBox IsChecked="{Binding ShowPsd1Events}" Content="Show PSD1" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,15,0"/>
                             <CheckBox IsChecked="{Binding ShowPnfEvents}" Content="Show PNF" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,15,0"/>
                             <CheckBox IsChecked="{Binding ShowPowerShellEvents}" Content="Show PowerShell" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,10,0"/>
                             <CheckBox IsChecked="{Binding ShowSystem32Events}" Content="Show System32" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,10,0"/>
                             <CheckBox IsChecked="{Binding ShowWindowsEvents}" Content="Show Windows" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,15,0"/>
                             
                             <TextBlock Text="Limit:" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,5,0"/>
                             <TextBox Text="{Binding MaxLiveItems}" Width="40" Background="#333" Foreground="White" BorderThickness="1" BorderBrush="#555" Padding="2" VerticalContentAlignment="Center"/>
                        </StackPanel>
                        
                        <Grid Grid.Row="2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <DataGrid ItemsSource="{Binding RecentActivity}" AutoGenerateColumns="False" 
                                      Background="Transparent" BorderThickness="0" HeadersVisibility="Column"
                                      IsReadOnly="True" RowBackground="#222" AlternatingRowBackground="#2A2A2A" Foreground="White">
                                <DataGrid.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="🚫 Ignore Process" 
                                                  Command="{Binding Data.IgnoreProcessCommand, Source={StaticResource Proxy}}"
                                                  CommandParameter="{Binding ProcessName}"/>
                                        <Separator/>
                                        <MenuItem Header="📂 Open in Explorer" 
                                                  Command="{Binding Data.OpenInExplorerCommand, Source={StaticResource Proxy}}"
                                                  CommandParameter="{Binding Path=PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                    </ContextMenu>
                                </DataGrid.ContextMenu>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Time" Binding="{Binding Timestamp, StringFormat=HH:mm:ss}" Width="80"/>
                                    <DataGridTextColumn Header="Operation" Binding="{Binding Operation}" Width="100"/>
                                    <DataGridTextColumn Header="Process" Binding="{Binding ProcessName}" Width="150"/>
                                    <DataGridTextColumn Header="User" Binding="{Binding UserName}" Width="100"/>
                                    <DataGridTextColumn Header="Path" Binding="{Binding FilePath}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>

                            <!-- Ignored Processes Side Panel -->
                            <Border Grid.Column="1" Width="250" Background="#1A1A1A" BorderBrush="#333" BorderThickness="1,0,0,0" Margin="10,0,0,0"
                                    Visibility="{Binding ShowIgnoredProcesses, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <Grid Margin="10">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    <TextBlock Text="IGNORED PROCESSES" FontWeight="Bold" Foreground="Gray" Margin="0,0,0,10"/>
                                    
                                    <ListBox Grid.Row="1" ItemsSource="{Binding IgnoredProcesses}" Background="Transparent" BorderThickness="0" Foreground="White">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <Grid Margin="0,2">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                                    <Button Grid.Column="1" Content="&#xEF2C;" FontFamily="Segoe MDL2 Assets" 
                                                            Background="Transparent" Foreground="Red" BorderThickness="0"
                                                            Command="{Binding DataContext.RemoveIgnoredProcessCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                            CommandParameter="{Binding}"/>
                                                </Grid>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </Grid>
                            </Border>
                        </Grid>
                    </Grid>


                    <Grid Visibility="{Binding CurrentViewName, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=FILES_CHANGES}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                             <TextBlock Text="OFFLINE FILE CHANGES HISTORY" FontWeight="SemiBold" Foreground="LightGray" VerticalAlignment="Center" Margin="0,0,20,0"/>
                             
                             <TextBlock Text="Load Last:" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,5,0"/>
                             <TextBox Text="{Binding MaxOfflineItems, UpdateSourceTrigger=PropertyChanged}" Width="50" Background="#333" Foreground="White" BorderThickness="1" BorderBrush="#555" Padding="2" VerticalContentAlignment="Center" Margin="0,0,10,0"/>
                             <TextBlock Text="Events" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,15,0"/>
                             
                             <Button Command="{Binding LoadOfflineHistoryCommand}" Content="🔄 Reload History" Background="#333" Foreground="White" Padding="10,2" BorderThickness="0"/>
                        </StackPanel>
                        
                        <DataGrid Grid.Row="1" ItemsSource="{Binding OfflineActivity}" SelectedItem="{Binding SelectedOfflineEvent}" AutoGenerateColumns="False" 
                                  Background="Transparent" BorderThickness="0" HeadersVisibility="Column"
                                  IsReadOnly="True" RowBackground="#222" AlternatingRowBackground="#2A2A2A" Foreground="White">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Modified Time" Binding="{Binding Timestamp, StringFormat=yyyy-MM-dd HH:mm:ss}" Width="150"/>
                                <DataGridTextColumn Header="Operation" Binding="{Binding Operation}" Width="100"/>
                                <DataGridTextColumn Header="Path" Binding="{Binding FilePath}" Width="*"/>
                                <DataGridTextColumn Header="Details" Binding="{Binding Details}" Width="200"/>
                            </DataGrid.Columns>
                           <DataGrid.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="🔍 Show Analysis Details" Command="{Binding ShowOfflineEventDetailsCommand}"/>
                                </ContextMenu>
                           </DataGrid.ContextMenu>
                        </DataGrid>
                    </Grid>

                    <!-- DUPLICATES View -->
                    <Grid Visibility="{Binding CurrentViewName, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=DUPLICATES}">
                         <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                            <TextBlock Text="DUPLICATE FILE FINDER" FontWeight="SemiBold" Foreground="LightGray" VerticalAlignment="Center" Margin="0,0,20,0"/>
                            <Button Command="{Binding ScanDuplicatesCommand}" Content="Scan Now" Background="#333" Foreground="White" Padding="10,2"/>
                        </StackPanel>
                        
                        <DataGrid Grid.Row="1" ItemsSource="{Binding DuplicateFiles}" AutoGenerateColumns="False" 
                                  Background="Transparent" BorderThickness="0" HeadersVisibility="Column"
                                  IsReadOnly="True" RowBackground="#222" AlternatingRowBackground="#2A2A2A" Foreground="White">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Hash" Binding="{Binding CurrentHash}" Width="200"/>
                                <DataGridTextColumn Header="Path" Binding="{Binding FilePath}" Width="*"/>
                                <DataGridTextColumn Header="Size" Binding="{Binding FileSize, Converter={StaticResource FileSizeConverter}}" Width="80"/>
                                <DataGridTextColumn Header="Last Modified" Binding="{Binding LastModified}" Width="150"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>

                    <!-- SEMANTIC SEARCH View -->
                    <Grid Visibility="{Binding CurrentViewName, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=SEARCH}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <StackPanel Orientation="Vertical" Margin="0,10,0,10">
                            <TextBlock Text="SEARCH BY CONTENT DESCRIPTION" FontWeight="SemiBold" Foreground="LightGray" Margin="0,0,0,5"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}" Background="#333" Foreground="White" BorderThickness="0" Padding="5"/>
                                <Button Grid.Column="1" Command="{Binding SearchCommand}" Content="Analyze &amp; Search" Background="SpringGreen" Foreground="Black" Padding="10,5" Margin="10,0,0,0" FontWeight="Bold"/>
                            </Grid>
                        </StackPanel>
                        
                        <DataGrid Grid.Row="1" ItemsSource="{Binding SearchResults}" AutoGenerateColumns="False" 
                                  Background="Transparent" BorderThickness="0" HeadersVisibility="Column"
                                  IsReadOnly="True" RowBackground="#222" AlternatingRowBackground="#2A2A2A" Foreground="White"
                                  SelectedItem="{Binding SelectedFile}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Path" Binding="{Binding FilePath}" Width="*"/>
                                <DataGridTextColumn Header="Last Modified" Binding="{Binding LastModified}" Width="150"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                    
                    <!-- FILE DETAILS View -->
                    <Grid Visibility="{Binding CurrentViewName, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=DETAILS}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <StackPanel Margin="0,10">
                            <TextBlock Text="SELECTED FILE:" FontWeight="Bold" Foreground="Gray"/>
                            <TextBlock Text="{Binding SelectedFile.FilePath, TargetNullValue='(Select a file from Vault or Search)'}" Foreground="White" TextWrapping="Wrap" Margin="0,5"/>
                        </StackPanel>
                        
                        <StackPanel Grid.Row="1" Margin="0,10">
                            <TextBlock Text="USER TAGS (Comma Separated):" FontWeight="Bold" Foreground="Gray"/>
                            <TextBox Text="{Binding SelectedFileTags, UpdateSourceTrigger=PropertyChanged}" Background="#333" Foreground="White" Padding="5" Margin="0,5"/>
                            <Button Command="{Binding SaveTagsCommand}" Content="Save Tags" HorizontalAlignment="Right" Padding="15,5" Background="SpringGreen" Foreground="Black"/>
                        </StackPanel>
                    </Grid>

                


    <!-- TRANSCRIBE Queue View -->
    <Grid Visibility="{Binding CurrentViewName, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=TRANSCRIBE}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Controls -->
            <RowDefinition Height="*"/>    <!-- Queue -->
            <RowDefinition Height="200"/>  <!-- Caption -->
        </Grid.RowDefinitions>
        
        <TextBlock  Grid.Row="0" Text="TRANSCRIPTION" FontWeight="SemiBold" Foreground="LightGray" Margin="0,10,0,10"/>

        <!-- Transcription Controls Area -->
        <Border Grid.Row="1" Margin="0,0,0,10" Background="#222" Padding="10">
            <StackPanel>
                <StackPanel Orientation="Horizontal" Margin="10,0,10,10">
                     <Button Command="{Binding DownloadModelsCommand}" Content="⬇ Download AI Models" Background="#2E7D32" Foreground="White" Padding="15,5" Margin="0,0,20,0"/>
    
                     <TextBlock Text="Model:" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,5,0"/>
                     <ComboBox ItemsSource="{Binding WhisperModels}" SelectedItem="{Binding SelectedWhisperModel}" 
                               Width="120" Margin="0,0,20,0" VerticalContentAlignment="Center">
                         <ComboBox.Resources>
                             <Style TargetType="ComboBoxItem">
                                 <Setter Property="Background" Value="#333"/>
                                 <Setter Property="Foreground" Value="White"/>
                             </Style>
                         </ComboBox.Resources>
                     </ComboBox>
                                
                     <CheckBox IsChecked="{Binding IsEnglishOnly}" Content="English Only" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,20,0"/>

                     <Separator Width="1" Background="#444" Margin="10,5"/>
                     
                     <!-- GPU Control -->
                     <ToggleButton IsChecked="{Binding UseGpu}" Padding="10,5" Margin="0,0,10,0" Background="#333" BorderThickness="1">
                         <ToggleButton.Style>
                             <Style TargetType="ToggleButton">
                                 <Setter Property="Content" Value="🚀 GPU: OFF"/>
                                 <Setter Property="Foreground" Value="Gray"/>
                                 <Style.Triggers>
                                     <Trigger Property="IsChecked" Value="True">
                                         <Setter Property="Content" Value="🚀 GPU: ON"/>
                                         <Setter Property="Foreground" Value="SpringGreen"/>
                                     </Trigger>
                                 </Style.Triggers>
                             </Style>
                         </ToggleButton.Style>
                     </ToggleButton>

                     <TextBlock VerticalAlignment="Center" Margin="0,0,20,0">
                         <TextBlock.Style>
                             <Style TargetType="TextBlock">
                                 <Setter Property="Text" Value="⚠️ CUDA NOT DETECTED"/>
                                 <Setter Property="Foreground" Value="Red"/>
                                 <Setter Property="FontSize" Value="10"/>
                                 <Style.Triggers>
                                     <DataTrigger Binding="{Binding IsCudaAvailable}" Value="True">
                                         <Setter Property="Text" Value="✅ CUDA READY"/>
                                         <Setter Property="Foreground" Value="SpringGreen"/>
                                     </DataTrigger>
                                 </Style.Triggers>
                             </Style>
                         </TextBlock.Style>
                     </TextBlock>
                     
                     <Button Command="{Binding ReTranscribeSelectedTaskCommand}" Content="🔄 Re-Transcribe Selected" 
                             Background="#FF6600" Foreground="White" Padding="15,5" Margin="0,0,0,0"
                             ToolTip="Re-transcribe the selected file with the currently selected model"/>
                </StackPanel>
            </StackPanel>
        </Border>
        
        <DataGrid Grid.Row="2" ItemsSource="{Binding TranscribeQueue}" AutoGenerateColumns="False" 
                  Background="Transparent" BorderThickness="0" HeadersVisibility="Column"
                  IsReadOnly="True" RowBackground="#222" AlternatingRowBackground="#2A2A2A" Foreground="White"
                  SelectedItem="{Binding SelectedTranscriptionTask}">
            <DataGrid.Columns>
                <DataGridTextColumn Header="File" Binding="{Binding FileName}" Width="200"/>
                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="100"/>
                <DataGridTextColumn Header="Model" Binding="{Binding ModelUsed}" Width="180"/>
                <DataGridTextColumn Header="Queued" Binding="{Binding QueuedAt, StringFormat=HH:mm:ss}" Width="100"/>
            </DataGrid.Columns>
        </DataGrid>
        
        <Grid Grid.Row="3" Background="#222" Margin="0,10,0,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <TextBlock Text="GENERATED TRANSCRIPT / CAPTION" Foreground="Gray" FontWeight="Bold" Margin="10,5"/>
            <TextBox Grid.Row="1" Text="{Binding SelectedTranscriptionTask.Transcript, Mode=OneWay}" 
                     Background="Transparent" Foreground="White" BorderThickness="0" 
                     TextWrapping="Wrap" VerticalScrollBarVisibility="Auto" IsReadOnly="True" Padding="10"/>
        </Grid>
    </Grid>

    <!-- Ignore List View -->
    <Grid Visibility="{Binding CurrentViewName, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=IGNORE_LIST}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="#222" CornerRadius="4" Padding="15" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel>
                    <TextBlock Text="MANAGED IGNORE LIST" FontSize="20" FontWeight="Bold" Foreground="White" Margin="0,0,0,5"/>
                    <TextBlock Text="Grouped by lowest common parent directory. Click on a path to expand the ignore scope to its parents." Foreground="LightGray" TextWrapping="Wrap"/>
                </StackPanel>
                <Button Grid.Column="1" Command="{Binding RefreshIgnoreListCommand}" 
                        Content="🔄 REFRESH LIST" 
                        Background="RoyalBlue" Foreground="White" FontWeight="Bold"
                        Padding="20,10" VerticalAlignment="Center" BorderThickness="0"/>
            </Grid>
        </Border>

        <ScrollViewer Grid.Row="1">
            <ItemsControl ItemsSource="{Binding IgnoredGroups}">
                <!-- Placeholder if list is empty -->
                <ItemsControl.Style>
                    <Style TargetType="ItemsControl">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IgnoredGroups.Count}" Value="0">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate>
                                            <TextBlock Text="No files or folders are currently ignored." 
                                                     Foreground="Gray" HorizontalAlignment="Center" Margin="0,50,0,0" FontSize="16"/>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ItemsControl.Style>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Background="#222" Margin="0,0,0,10" CornerRadius="4" Padding="10">
                            <StackPanel>
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="📂 Group:" Foreground="Gray" Margin="0,0,5,0" VerticalAlignment="Center"/>
                                        <ItemsControl ItemsSource="{Binding ParentHierarchy}" VerticalAlignment="Center">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Orientation="Horizontal">
                                                        <Button Content="{Binding}" Background="Transparent" BorderThickness="0" Foreground="SpringGreen" Padding="2,0"
                                                              Command="{Binding DataContext.ReplaceWithParentIgnoreCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                              CommandParameter="{Binding}" Cursor="Hand">
                                                            <Button.ToolTip>
                                                                <ToolTip Content="Ignore this entire directory instead"/>
                                                            </Button.ToolTip>
                                                        </Button>
                                                        <TextBlock Text=" > " Foreground="Gray" VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                <Button Grid.Column="1" Content="Remove Group" Background="#444" Foreground="White" Padding="10,2"
                                          Command="{Binding DataContext.UnignoreGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                          CommandParameter="{Binding}"/>
                            </Grid>
                                
                                <ItemsControl ItemsSource="{Binding Rules}" Margin="20,5,0,0">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,2">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="{Binding Path}" Foreground="LightGray" VerticalAlignment="Center"/>
                                                <Button Grid.Column="1" Content="&#xEF2C;" FontFamily="Segoe MDL2 Assets" Background="Transparent" Foreground="Red" 
                                                      BorderThickness="0" Padding="5,0" Command="{Binding DataContext.UnignoreRuleCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                      CommandParameter="{Binding}"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>

                    <!-- SETTINGS View -->
                    <Grid Visibility="{Binding CurrentViewName, Converter={StaticResource ViewToVisibilityConverter}, ConverterParameter=SETTINGS}">
                        <StackPanel Margin="20">
                            <TextBlock Text="APPLICATION SETTINGS" FontWeight="Bold" Foreground="Gray" Margin="0,0,0,20"/>

                            <GroupBox Header="Data Privacy" BorderBrush="#444" Foreground="White" Margin="0,0,0,20" Padding="10">
                                <StackPanel>
                                    <CheckBox IsChecked="{Binding IsAnalyticsEnabled}" Content="Allow anonymous data collection for improvement and bug fixes" 
                                              Foreground="White" FontSize="14" Margin="0,5"/>
                                    <TextBlock Text="We collect basic usage events (e.g., app launch, scan completion) to specific features. No personal file content is ever transmitted." 
                                               Foreground="Gray" TextWrapping="Wrap" Margin="25,5,0,0"/>
                                </StackPanel>
                            </GroupBox>

                            <GroupBox Header="About" BorderBrush="#444" Foreground="White" Padding="10">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,5">
                                        <TextBlock Text="App Version:" Foreground="Gray" Width="100"/>
                                        <TextBlock Text="{Binding AppVersion}" Foreground="White" FontWeight="Bold"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,5">
                                        <TextBlock Text="Developer:" Foreground="Gray" Width="100"/>
                                        <TextBlock Text="Magicpoint.ai" Foreground="White"/>
                                    </StackPanel>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </Grid>

                </Grid>
            </Border>
        </Grid>


        </Grid> <!-- End Header/Content Wrapper -->

        <!-- Footer - Shows Scan Status and Statistics -->
        <StatusBar Grid.Row="1" Background="#111111" Foreground="Gray" Padding="5,2">
            <StatusBarItem>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Total: " FontWeight="Bold"/>
                    <TextBlock Text="{Binding TotalFiles}" Foreground="LightBlue" Margin="0,0,15,0"/>
                    
                    <TextBlock Text="Video: " FontWeight="Bold"/>
                    <TextBlock Text="{Binding TotalVideoFiles}" Foreground="Orange" Margin="0,0,15,0"/>
                    
                    <TextBlock Text="Audio: " FontWeight="Bold"/>
                    <TextBlock Text="{Binding TotalAudioFiles}" Foreground="Purple" Margin="0,0,15,0"/>
                    
                    <TextBlock Text="Code Lines: " FontWeight="Bold"/>
                    <TextBlock Text="{Binding TotalCodeFiles}" Foreground="SpringGreen" Margin="0,0,15,0"/>
                    
                    <Separator Width="1" Background="#333" Margin="10,0"/>

                    <TextBlock Text="Selected: " FontWeight="Bold" Foreground="White"/>
                    <TextBlock Text="{Binding SelectedItemsCount}" Foreground="SpringGreen" Margin="5,0,0,0"/>
                    <TextBlock Text=" files (" Foreground="Gray"/>
                    <TextBlock Text="{Binding SelectedItemsSize, Converter={StaticResource FileSizeConverter}}" Foreground="SpringGreen"/>
                    <TextBlock Text=")" Foreground="Gray"/>
                    
                    <TextBlock Text="{Binding ScanETA}" Foreground="Yellow" FontWeight="Bold" Margin="20,0,0,0" VerticalAlignment="Center"/>
                    
                    <!-- Hash Progress -->
                    <TextBlock Text="{Binding HashProgress}" Foreground="Cyan" Margin="10,0,0,0" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding HashETA}" Foreground="Cyan" FontWeight="Bold" Margin="10,0,0,0" VerticalAlignment="Center"/>

                    <Separator Width="1" Background="#333" Margin="10,0"/>

                    <TextBlock Text="Last Scanned: " Foreground="Gray"/>
                    <TextBlock Text="{Binding LastScannedTime}" Foreground="White" Margin="0,0,15,0"/>

                    <Separator Width="1" Background="#333" Margin="10,0"/>
                    
                    <TextBlock Text="Status: " FontWeight="Bold"/>
                    <TextBlock Text="{Binding StatusMessage}" Foreground="SpringGreen" Margin="0,0,20,0"/>
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
        
        <!-- EULA Overlay -->
        <Grid Grid.RowSpan="2" Background="#D9000000" Visibility="{Binding IsEulaVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Border Background="#1E1E1E" BorderBrush="#444" BorderThickness="1" CornerRadius="8" Width="600" Height="500" HorizontalAlignment="Center" VerticalAlignment="Center">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="20" ShadowDepth="10" Opacity="0.5" Direction="270" Color="Black"/>
                </Border.Effect>
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Text="WELCOME TO SECURE FILE MONITOR" FontSize="20" FontWeight="Bold" Foreground="SpringGreen" HorizontalAlignment="Center" Margin="0,0,0,20"/>
                    
                    <ScrollViewer Grid.Row="1" Margin="0,0,0,20" Background="#111" Padding="10">
                        <TextBlock Text="{Binding EulaText}" Foreground="#CCC" FontFamily="Consolas" TextWrapping="Wrap"/>
                    </ScrollViewer>
                    
                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Command="{Binding DeclineEulaCommand}" Content="Decline (Exit)" Background="#8B0000" Foreground="White" Padding="15,8" Margin="0,0,10,0" FontWeight="Bold"/>
                        <Button Command="{Binding AcceptEulaCommand}" Content="I Agree &amp; Launch" Background="SpringGreen" Foreground="Black" Padding="20,8" FontWeight="Bold"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

    </Grid>
</Window>
